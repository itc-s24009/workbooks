# プロジェクト仕様書

## プロジェクト概要

**プロジェクト名**: my-study-app  
**バージョン**: 0.1.0  
**目的**: フラッシュカードを用いた学習アプリケーション（学習帳管理システム）

## 技術スタック

### フロントエンド・フレームワーク

- **Next.js** 16.1.4 (App Router)
- **React** 19.2.3
- **TypeScript** 5.x
- **Tailwind CSS** 4.x

### バックエンド・データベース

- **Prisma** 6.19.2 (ORM)
- **PostgreSQL** (Neon Database)
- **NextAuth.js** 5.0.0-beta.30 (認証)

### 認証プロバイダー

- Google OAuth 2.0

## データベース構造

### モデル一覧

#### 1. User (ユーザー)

ユーザー情報を管理

| フィールド | 型            | 説明                  |
| ---------- | ------------- | --------------------- |
| id         | String (UUID) | ユーザーID (主キー)   |
| name       | String?       | ユーザー名            |
| email      | String        | メールアドレス (一意) |
| createdAt  | DateTime      | 作成日時              |
| updatedAt  | DateTime      | 更新日時              |

**リレーション**:

- directories: ディレクトリ一覧
- workbooks: 学習帳一覧
- sessions: 学習セッション一覧
- sentShares: 送信した共有一覧
- receivedShares: 受信した共有一覧

#### 2. Directory (ディレクトリ)

学習帳を階層的に整理するためのフォルダ

| フィールド | 型            | 説明                    |
| ---------- | ------------- | ----------------------- |
| id         | String (UUID) | ディレクトリID (主キー) |
| userId     | String        | ユーザーID (外部キー)   |
| parentId   | String?       | 親ディレクトリID        |
| name       | String        | ディレクトリ名          |
| createdAt  | DateTime      | 作成日時                |
| updatedAt  | DateTime      | 更新日時                |

**リレーション**:

- user: 所有ユーザー
- parent: 親ディレクトリ
- children: 子ディレクトリ一覧
- workbooks: 含まれる学習帳一覧

#### 3. Workbook (学習帳)

フラッシュカードのコレクション

| フィールド  | 型            | 説明                  |
| ----------- | ------------- | --------------------- |
| id          | String (UUID) | 学習帳ID (主キー)     |
| userId      | String        | ユーザーID (外部キー) |
| parentId    | String?       | 親ディレクトリID      |
| name        | String        | 学習帳名              |
| description | String?       | 説明                  |
| createdAt   | DateTime      | 作成日時              |
| updatedAt   | DateTime      | 更新日時              |

**リレーション**:

- user: 所有ユーザー
- directory: 親ディレクトリ
- cards: カード一覧
- sessions: 学習セッション一覧
- shares: 共有情報一覧

#### 4. Card (カード)

学習用のフラッシュカード（問題と解答のペア）

| フィールド | 型            | 説明                |
| ---------- | ------------- | ------------------- |
| id         | String (UUID) | カードID (主キー)   |
| workbookId | String        | 学習帳ID (外部キー) |
| question   | String        | 問題文              |
| answer     | String        | 解答                |
| createdAt  | DateTime      | 作成日時            |
| updatedAt  | DateTime      | 更新日時            |

**リレーション**:

- workbook: 所属する学習帳
- records: 学習記録一覧

#### 5. StudySession (学習セッション)

学習の実施記録

| フィールド   | 型            | 説明                  |
| ------------ | ------------- | --------------------- |
| id           | String (UUID) | セッションID (主キー) |
| userId       | String        | ユーザーID (外部キー) |
| workbookId   | String        | 学習帳ID (外部キー)   |
| accuracyRate | Float         | 正解率                |
| createdAt    | DateTime      | 作成日時              |
| updatedAt    | DateTime      | 更新日時              |

**リレーション**:

- user: ユーザー
- workbook: 学習帳
- records: 個別カードの記録一覧

#### 6. StudyRecord (学習記録)

個別カードごとの学習結果

| フィールド | 型            | 説明                    |
| ---------- | ------------- | ----------------------- |
| id         | String (UUID) | 記録ID (主キー)         |
| sessionId  | String        | セッションID (外部キー) |
| cardId     | String        | カードID (外部キー)     |
| isCorrect  | Boolean       | 正解したか              |
| createdAt  | DateTime      | 作成日時                |

**リレーション**:

- session: 学習セッション
- card: カード

#### 7. Share (共有)

ユーザー間での学習帳共有

| フィールド | 型            | 説明                |
| ---------- | ------------- | ------------------- |
| id         | String (UUID) | 共有ID (主キー)     |
| senderId   | String        | 送信者ID (外部キー) |
| receiverId | String        | 受信者ID (外部キー) |
| workbookId | String        | 学習帳ID (外部キー) |
| createdAt  | DateTime      | 作成日時            |

**リレーション**:

- sender: 送信者
- receiver: 受信者
- workbook: 共有される学習帳

## API・認証

### NextAuth.js 設定

**認証フロー**:

1. Google OAuth 2.0による認証
2. セッション管理

**必要な環境変数**:

```env
GOOGLE_CLIENT_ID=<Google OAuthクライアントID>
GOOGLE_CLIENT_SECRET=<Google OAuthクライアントシークレット>
DATABASE_URL=<PostgreSQLデータベースURL>
```

**主要な関数**:

- `signIn(provider)`: ログイン処理
- `signOut()`: ログアウト処理
- `auth()`: 現在のセッション取得

## プロジェクト構造

```
my-study-app/
├── prisma/
│   ├── schema.prisma          # Prismaスキーマ定義
│   └── migrations/            # データベースマイグレーション
├── src/
│   ├── app/
│   │   ├── page.tsx          # ホームページ
│   │   ├── login/page.tsx    # ログインページ
│   │   └── api/auth/         # NextAuth.js APIルート
│   ├── components/
│   │   └── auth/action.ts    # 認証アクション
│   ├── lib/
│   │   ├── prisma.ts         # Prismaクライアント初期化
│   │   ├── user.ts           # ユーザー情報取得
│   │   └── db/user.ts        # ユーザーDB操作
│   └── generated/prisma/     # Prisma生成ファイル
└── auth.ts                    # NextAuth.js設定
```

## 使用例

### 1. 認証機能

#### ログインページ

```tsx
// src/app/login/page.tsx
import { signInAction, signOutAction } from "@/components/auth/action";
import { getUserInfo } from "@/lib/user";

export default async function Page() {
  const user = await getUserInfo();

  return user ? (
    <div>
      <h1>ようこそ、{user.name}さん</h1>
      <form action={signOutAction}>
        <button>ログアウト</button>
      </form>
    </div>
  ) : (
    <div>
      <h1>ログインテスト</h1>
      <form action={signInAction("google")}>
        <button>ログイン</button>
      </form>
    </div>
  );
}
```

### 2. ユーザー情報取得

#### ユーザー情報の取得

```typescript
// src/lib/user.ts
import { auth } from "../../auth";
import { getUserByEmail } from "./db/user";

export async function getUserInfo() {
  const session = await auth();
  const email = session?.user?.email || null;
  return email ? await getUserByEmail(email) : null;
}
```

#### データベースからユーザー取得

```typescript
// src/lib/db/user.ts
import prisma from "../prisma";

export function getUserByEmail(email: string) {
  return prisma.$transaction(async (prisma) => {
    return await prisma.user.findUnique({
      where: {
        email: email,
      },
    });
  });
}
```

### 3. データベース操作の基本パターン

#### ユーザー作成

```typescript
await prisma.user.create({
  data: {
    email: "user@example.com",
    name: "山田太郎",
  },
});
```

#### 学習帳作成

```typescript
await prisma.workbook.create({
  data: {
    name: "英単語帳",
    description: "TOEIC対策用",
    userId: "user-uuid-here",
    parentId: "directory-uuid-here", // オプション
  },
});
```

#### カード作成

```typescript
await prisma.card.create({
  data: {
    workbookId: "workbook-uuid-here",
    question: "apple",
    answer: "りんご",
  },
});
```

#### 学習セッション記録

```typescript
// セッション作成
const session = await prisma.studySession.create({
  data: {
    userId: "user-uuid-here",
    workbookId: "workbook-uuid-here",
    accuracyRate: 0.85,
  },
});

// 個別カードの記録
await prisma.studyRecord.create({
  data: {
    sessionId: session.id,
    cardId: "card-uuid-here",
    isCorrect: true,
  },
});
```

#### 学習帳の共有

```typescript
await prisma.share.create({
  data: {
    senderId: "sender-user-uuid",
    receiverId: "receiver-user-uuid",
    workbookId: "workbook-uuid-here",
  },
});
```

### 4. リレーションを含むデータ取得

#### ユーザーの学習帳一覧（カード含む）

```typescript
const workbooksWithCards = await prisma.workbook.findMany({
  where: {
    userId: "user-uuid-here",
  },
  include: {
    cards: true,
    directory: true,
  },
});
```

#### 学習セッションの詳細（記録含む）

```typescript
const sessionDetail = await prisma.studySession.findUnique({
  where: {
    id: "session-uuid-here",
  },
  include: {
    records: {
      include: {
        card: true,
      },
    },
    workbook: true,
  },
});
```

## 開発コマンド

```bash
# 開発サーバー起動
npm run dev

# ビルド
npm run build

# 本番サーバー起動
npm start

# リンター実行
npm run lint

# Prismaマイグレーション
npx prisma migrate dev

# Prismaクライアント生成
npx prisma generate

# Prisma Studio起動（DB GUI）
npx prisma studio
```

## 今後の開発予定機能

- [ ] 学習帳・カードのCRUD機能
- [ ] ディレクトリ管理機能
- [ ] 学習セッション実施UI
- [ ] 学習履歴・統計表示
- [ ] 学習帳共有機能UI
- [ ] カード検索機能
- [ ] スパンド学習アルゴリズム統合
